name: Deploy API to Cloud Run

on:
  push:
    branches:
      - main
    paths:
      - "apps/api/**"
      - "libs/shared/**"
      - ".github/workflows/deploy-api.yml"
  workflow_dispatch:
env:
  PROJECT_ID: senteng-erp-pro
  SERVICE: erp-api
  REGION: asia-east1

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/api

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install root dependencies
        run: npm ci
        working-directory: .

      - name: Install API dependencies
        run: npm install

      - name: Build API
        run: npm run build

      - name: Sync migrations table for existing schema
        run: |
          npm install pg
          node -e "
          const { Client } = require('pg');
          const path = require('path');
          const fs = require('fs');
          const client = new Client({
            host: process.env.DB_HOST,
            port: process.env.DB_PORT,
            user: process.env.DB_USERNAME,
            password: process.env.DB_PASSWORD,
            database: process.env.DB_DATABASE,
            ssl: { rejectUnauthorized: false }
          });

          (async () => {
            await client.connect();
            await client.query(\`
              CREATE TABLE IF NOT EXISTS migrations (
                id SERIAL PRIMARY KEY,
                timestamp BIGINT NOT NULL,
                name VARCHAR(255) NOT NULL
              )
            \`);
            
            // Auto-discover migrations from built output
            const migrationDir = path.join(__dirname, 'dist', 'migrations');
            const files = fs.readdirSync(migrationDir).filter(f => f.endsWith('.js') && !f.startsWith('README'));
            
            for (const file of files) {
              const match = file.match(/^(\d+)-(.+)\.js$/);
              if (!match) continue;
              const [, timestamp, name] = match;
              const fullName = name + timestamp;
              try {
                await client.query(
                  'INSERT INTO migrations (timestamp, name) VALUES (\$1, \$2) ON CONFLICT DO NOTHING',
                  [timestamp, fullName]
                );
                console.log('Synced:', fullName);
              } catch (e) {
                console.log('Skipped (exists):', fullName);
              }
            }
            await client.end();
            console.log('Migration sync complete');
          })();
          "
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}

      - name: Build data-source for migrations
        run: npx tsc src/data-source.ts --outDir dist --esModuleInterop --module commonjs --skipLibCheck

      - name: Run database migrations
        run: npx typeorm migration:run -d dist/data-source.js --transaction each
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build Docker image
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/cloud-run-source-deploy/${{ env.SERVICE }}:${{ github.sha }} .
        working-directory: apps/api

      - name: Push Docker image
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/cloud-run-source-deploy/${{ env.SERVICE }}:${{ github.sha }}

      - name: Create GCP Secrets (idempotent)
        run: |
          for secret in db-username db-password db-database jwt-secret; do
            if ! gcloud secrets describe $secret --project=${{ env.PROJECT_ID }} &>/dev/null; then
              echo "Creating secret: $secret"
              echo -n "placeholder" | gcloud secrets create $secret --data-file=- --project=${{ env.PROJECT_ID }}
            fi
          done
          echo -n "${{ secrets.DB_USERNAME }}" | gcloud secrets versions add db-username --data-file=- --project=${{ env.PROJECT_ID }}
          echo -n "${{ secrets.DB_PASSWORD }}" | gcloud secrets versions add db-password --data-file=- --project=${{ env.PROJECT_ID }}
          echo -n "${{ secrets.DB_DATABASE }}" | gcloud secrets versions add db-database --data-file=- --project=${{ env.PROJECT_ID }}
          echo -n "${{ secrets.JWT_SECRET }}" | gcloud secrets versions add jwt-secret --data-file=- --project=${{ env.PROJECT_ID }}

      - name: Deploy to Cloud Run
        run: |
          REVISION_SUFFIX=$(date +%Y%m%d-%H%M%S)
          gcloud run deploy ${{ env.SERVICE }} \
            --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/cloud-run-source-deploy/${{ env.SERVICE }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --add-cloudsql-instances=${{ env.PROJECT_ID }}:${{ env.REGION }}:erp-postgres \
            --revision-suffix=${REVISION_SUFFIX} \
            --set-env-vars="NODE_ENV=production,GCP_PROJECT_ID=${{ env.PROJECT_ID }},GCP_BUCKET_NAME=senteng-erp-files,DB_HOST=/cloudsql/${{ env.PROJECT_ID }}:${{ env.REGION }}:erp-postgres,DB_PORT=5432,CORS_ORIGINS=https://senteng.co,FRONTEND_URL=https://senteng.co" \
            --update-secrets="DB_USERNAME=db-username:latest,DB_PASSWORD=db-password:latest,DB_DATABASE=db-database:latest,JWT_SECRET=jwt-secret:latest"
